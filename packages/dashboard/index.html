<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>LocAid Dashboard</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600&display=swap" rel="stylesheet">
    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: 'Barlow', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #container {
            display: flex;
            height: 100%;
        }
        #sidebar {
            width: 300px;
            padding: 0;
            box-sizing: border-box;
            background: #ffffff;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
        }
        .sidebar-header {
            background: #990909;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .sidebar-header img {
            height: 35px;
            width: auto;
            margin-bottom: 5px;
        }
        .sidebar-content {
            padding: 20px;
        }
        .sidebar-content h1 {
            color: #211414;
            font-weight: 600;
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .sidebar-content h2 {
            color: #990909;
            font-weight: 600;
            font-size: 1.1em;
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 2px solid #990909;
            padding-bottom: 5px;
        }
        #connection-status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 400;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            color: #798491;
        }
        #notifyBtn {
            background-color: #990909;
            color: white;
            border: none;
            border-radius: 4px;
            font-family: 'Barlow', sans-serif;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #notifyBtn:hover:not(:disabled) {
            background-color: #7a0707;
        }
        #notifyBtn:disabled {
            background-color: #798491;
            cursor: not-allowed;
        }
        #copy-coordinates-btn {
            background-color: #990909;
            font-family: 'Barlow', sans-serif;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #copy-coordinates-btn:hover {
            background-color: #7a0707;
        }
        #live-units-list {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        #live-units-list div {
            padding: 8px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-family: 'Barlow', sans-serif;
            color: #211414;
        }
        #live-units-list div:hover {
            background-color: rgba(153, 9, 9, 0.1);
            color: #990909;
        }
        #live-units-list div:last-child {
            border-bottom: none;
        }
        #selected-user-panel {
            border: 2px solid #990909;
            border-radius: 4px;
            padding: 15px;
            background: #ffffff;
        }
        #selected-user-panel h2 {
            margin-top: 0;
            color: #990909;
            border-bottom: 1px solid #990909;
        }
        #selected-user-info {
            font-family: 'Barlow', sans-serif;
            color: #211414;
            line-height: 1.5;
        }
        #viewDiv {
            flex-grow: 1;
        }
        #status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 2;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            max-height: 80%;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.2em;
        }
        .close-button {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-body {
            overflow-y: auto;
        }
        .modal-body ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .modal-body li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
    </style>
    <script src="https://js.arcgis.com/4.29/"></script>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <div class="sidebar-header">
                <img src="imgs/logo-w.png" alt="LocAid">
            </div>
            <div class="sidebar-content">
                <h2>Connection Status</h2>
                <div id="connection-status">Connecting to relay server...</div>
                <h2>Layers</h2>
                <div id="layerlist-container"></div>
                <h2>Actions</h2>
                <button id="notifyBtn" style="width: 100%; padding: 10px; font-size: 1em;" disabled>Notify Vulnerable Addresses</button>
                <h2>Live Units</h2>
                <div id="live-units-list" style="max-height: 200px; overflow-y: auto;"></div>
                <div id="selected-user-panel" style="display: none; margin-top: 15px;">
                    <h2>Selected Unit</h2>
                    <div id="selected-user-info"></div>
                    <button id="copy-coordinates-btn" style="width: 100%; padding: 10px; font-size: 1em; margin-top: 10px; color: white; border: none; border-radius: 3px; cursor: pointer;">Copy Coordinates</button>
                </div>
            </div>
        </div>
        <div id="viewDiv"></div>
    </div>
    <div id="status"></div>

    <div id="notification-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Notified Users</h2>
                <span class="close-button">&times;</span>
            </div>
            <div id="notified-users-list" class="modal-body">
                <!-- List will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Dynamically set the IP for the WebSocket connection
        const WEBSOCKET_IP = window.location.hostname;
        const WEBSOCKET_PORT = 3000;
        // Connect over a SECURE WebSocket connection (wss)
        const WEBSOCKET_URL = `wss://${WEBSOCKET_IP}:${WEBSOCKET_PORT}`;

        // --- DOM ELEMENTS ---
        const statusDiv = document.getElementById('status');
        const connectionStatusDiv = document.getElementById('connection-status');

        require([
            "esri/config",
            "esri/WebMap",
            "esri/views/MapView",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/geometry/Point", // <-- Import the Point class
            "esri/geometry/geometryEngine",
            "esri/widgets/LayerList",
            "esri/widgets/Directions",
            "esri/layers/FeatureLayer",
            "esri/layers/RouteLayer"
        ], function(esriConfig, WebMap, MapView, GraphicsLayer, Graphic, Point, geometryEngine, LayerList, Directions, FeatureLayer, RouteLayer) {

            // --- API KEY CONFIGURATION ---
            esriConfig.apiKey = "AAPTxy8BH1VEsoebNVZXo8HurOqdg02N3NcBHh5U_6TjOfCWbm0rO5jbMMbYBQsZrkiB8FuqCe6kmM5LsDMntpSdYkBowD-oSzqCKLux7qavHaZqkENGNdkVR-kg-fvY2SIxyOGNCylAcPkGGX1niZ5GqKYHuGsHBduSP2BF7Tb0zxnWvmyvy4QnHqRYo88EENoSQ54WZpq-oIDrgrtQNd3pDfce00SpGWekoxhQ9-aSC56_KtXf0XbQDmFEMAbwPKh1AT1_tBDR4aZB"; 

            // --- PROXY CONFIGURATION ---
            // This is a standard solution for CORS issues where a browser on one domain (localhost)
            // is blocked from accessing services on another domain. The proxy makes the request on our behalf.
            const prefixes = ["services", "services1", "services2", "services3", "services4", "services5", "services6", "services7", "services8", "services9"];
            prefixes.forEach(prefix => {
                esriConfig.request.proxyRules.push({
                    urlPrefix: `https://${prefix}.arcgis.com`,
                    proxyUrl: "https://www.arcgis.com/sharing/proxy"
                });
            });

            // Add a specific rule for the LA County GIS server
            esriConfig.request.proxyRules.push({
                urlPrefix: "https://public.gis.lacounty.gov",
                proxyUrl: "https://www.arcgis.com/sharing/proxy"
            });


            // Use a plain JavaScript Object as a dictionary to track graphics by deviceId.
            // Each entry will now hold both the point and the accuracy circle.
            const liveGraphics = {};
            const addressGraphics = {};
            let fireHazardLayer = null;
            let userSignUpLayer = null;
            const STALE_DATA_TIMEOUT = 30000; // 30 seconds
            let signUpData = []; // To store the results from the user layer

            // Application state tracking to ensure all data is loaded before enabling features
            let appState = {
                mapLoaded: false,
                fireHazardLayerReady: false,
                userDataLoaded: false
            };

            function checkIfAllDataReady() {
                if (appState.mapLoaded && appState.fireHazardLayerReady && appState.userDataLoaded) {
                    console.log("‚úÖ All data is ready! Enabling notifications.");
                    document.getElementById('notifyBtn').disabled = false;
                    updateStatus("All systems ready. Notifications enabled.", false);
                } else {
                    console.log("‚è≥ Waiting for data:", appState);
                }
            }

            const map = new WebMap({
                portalItem: {
                    id: "0d8708f95c71433daa14f4ad6965ff2d"
                }
            });

            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-118.15, 34.16], // Centered on the new operational area
                zoom: 12
            });

            // Create a graphics layer to hold the live points
            const graphicsLayer = new GraphicsLayer();
            graphicsLayer.listMode = "hide"; // Don't show in layer list

            // Define the labeling for the live trackers
            const labelClass = {
                symbol: {
                    type: "text",
                    color: "black",
                    haloSize: 1,
                    haloColor: "white",
                    font: { size: "10pt", family: "sans-serif", weight: "bold" }
                },
                labelPlacement: "above-right",
                labelExpressionInfo: {
                    expression: "$feature.deviceId"
                }
            };
            graphicsLayer.labelingInfo = [labelClass];

            map.add(graphicsLayer);

            // --- Directions Widget Setup ---
            const routeLayer = new RouteLayer();
            map.add(routeLayer);

            const directionsWidget = new Directions({
                view: view,
                layer: routeLayer,
                routeServiceUrl: "https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World"
            });
            view.ui.add(directionsWidget, "top-right");

            const layerList = new LayerList({
                view: view,
                container: "layerlist-container"
            });

            // Wait for the map and its layers to finish loading
            Promise.all([map.loadAll(), view.when()]).then(() => {
                console.log("üó∫Ô∏è WebMap loaded. Available layers:", map.allLayers.map(l => l.title).toArray());
                appState.mapLoaded = true;
                
                let selectedFeature = null;

                // --- Set up a click listener on the view ---
                view.on("click", (event) => {
                    view.hitTest(event).then((response) => {
                        // Check for LocAid Users first
                        const locaidResults = response.results.filter(r => r.graphic.layer && r.graphic.layer.title === "LocAid Users");
                        
                        // Check for live units (graphics from our graphicsLayer)
                        const liveUnitResults = response.results.filter(r => r.graphic.layer === graphicsLayer);
                        
                        if (locaidResults.length > 0) {
                            // Handle LocAid Users (existing functionality)
                            const clickedGraphic = locaidResults[0].graphic;
                            console.log("üñ±Ô∏è Clicked on LocAid user graphic:", clickedGraphic.attributes);
                            
                            // Find the full user data from our pre-loaded signUpData
                            const fullUserData = signUpData.find(feature => {
                                // Try multiple matching strategies
                                
                                // Strategy 1: Match by ObjectID (most reliable)
                                if (clickedGraphic.attributes && clickedGraphic.attributes.OBJECTID && 
                                    feature.attributes && feature.attributes.OBJECTID) {
                                    return clickedGraphic.attributes.OBJECTID === feature.attributes.OBJECTID;
                                }
                                
                                // Strategy 2: Match by FID (Feature ID)
                                if (clickedGraphic.attributes && clickedGraphic.attributes.FID && 
                                    feature.attributes && feature.attributes.FID) {
                                    return clickedGraphic.attributes.FID === feature.attributes.FID;
                                }
                                
                                // Strategy 3: Match by any unique ID field
                                if (clickedGraphic.attributes && feature.attributes) {
                                    const clickedAttrs = clickedGraphic.attributes;
                                    const featureAttrs = feature.attributes;
                                    
                                    // Try common ID field names
                                    const idFields = ['objectid', 'OBJECTID', 'fid', 'FID', 'id', 'ID', 'GlobalID', 'globalid'];
                                    for (const field of idFields) {
                                        if (clickedAttrs[field] && featureAttrs[field] && 
                                            clickedAttrs[field] === featureAttrs[field]) {
                                            return true;
                                        }
                                    }
                                }
                                
                                // Strategy 4: Coordinate matching with larger tolerance
                                const clickedGeom = clickedGraphic.geometry;
                                const featureGeom = feature.geometry;
                                
                                if (clickedGeom && featureGeom) {
                                    const tolerance = 0.001; // Increased tolerance for coordinate matching
                                    return Math.abs(clickedGeom.x - featureGeom.x) < tolerance && 
                                           Math.abs(clickedGeom.y - featureGeom.y) < tolerance;
                                }
                                
                                return false;
                            });

                            if (fullUserData) {
                                selectedFeature = fullUserData; // Use the full feature data
                                const attrs = fullUserData.attributes;
                                const name = `${attrs.first_name || ''} ${attrs.last_name || ''}`.trim();

                                document.getElementById('selected-user-info').innerHTML = `
                                    <strong>Name:</strong> ${name}<br>
                                    <strong>Phone:</strong> ${attrs.phone_number || 'N/A'}<br>
                                    <strong>Disability:</strong> ${attrs.disability_type || 'N/A'}
                                `;
                                document.getElementById('selected-user-panel').style.display = 'block';
                                console.log("‚úÖ Selected user:", attrs);
                            } else {
                                console.warn("‚ö†Ô∏è Could not find matching user data for clicked graphic");
                                console.log("Available signUpData sample:", signUpData.length > 0 ? signUpData[0].attributes : "No data loaded");
                                console.log("Clicked graphic attributes:", clickedGraphic.attributes);
                                console.log("Clicked graphic geometry:", clickedGraphic.geometry);
                                
                                // Fallback to using the clicked graphic directly
                                selectedFeature = clickedGraphic;
                                const attrs = clickedGraphic.attributes || {};
                                const name = `${attrs.first_name || ''} ${attrs.last_name || ''}`.trim();
                                
                                document.getElementById('selected-user-info').innerHTML = `
                                    <strong>Name:</strong> ${name}<br>
                                    <strong>Phone:</strong> ${attrs.phone_number || 'N/A'}<br>
                                    <strong>Disability:</strong> ${attrs.disability_type || 'N/A'}
                                `;
                                document.getElementById('selected-user-panel').style.display = 'block';
                            }
                        } else if (liveUnitResults.length > 0) {
                            // Handle Live Units (new functionality)
                            const clickedGraphic = liveUnitResults[0].graphic;
                            console.log("üñ±Ô∏è Clicked on live unit graphic:", clickedGraphic.attributes);
                            
                            const attrs = clickedGraphic.attributes;
                            const geometry = clickedGraphic.geometry;
                            const deviceId = attrs.deviceId;
                            
                            // Create a selectedFeature object for the live unit
                            selectedFeature = {
                                geometry: geometry,
                                attributes: {
                                    deviceId: deviceId,
                                    type: attrs.type || 'unknown',
                                    accuracy: attrs.accuracy || 'N/A',
                                    first_name: deviceId,
                                    last_name: '',
                                    phone_number: 'N/A',
                                    disability_type: attrs.type === 'responder' ? 'First Responder' : 'Live User'
                                }
                            };
                            
                            const name = deviceId;
                            const unitType = attrs.type === 'responder' ? 'First Responder' : 'Live User';
                            
                            document.getElementById('selected-user-info').innerHTML = `
                                <strong>Unit ID:</strong> ${name}<br>
                                <strong>Type:</strong> ${unitType}<br>
                                <strong>Accuracy:</strong> ${attrs.accuracy || 'N/A'}m<br>
                                <strong>Coordinates:</strong> ${geometry.latitude.toFixed(6)}, ${geometry.longitude.toFixed(6)}
                            `;
                            document.getElementById('selected-user-panel').style.display = 'block';
                            console.log("‚úÖ Selected live unit from map:", attrs);
                        }
                    });
                });

                // --- Event listener for copy coordinates button ---
                document.getElementById('copy-coordinates-btn').addEventListener('click', () => {
                    if (selectedFeature && selectedFeature.geometry) {
                        const coords = selectedFeature.geometry;
                        const attrs = selectedFeature.attributes || {};
                        const name = `${attrs.first_name || ''} ${attrs.last_name || ''}`.trim();
                        
                        // Format coordinates in multiple useful formats
                        const coordText = `${name ? name + ' - ' : ''}Coordinates:
Decimal Degrees: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}
Lat/Lon: ${coords.latitude.toFixed(6)}¬∞N, ${Math.abs(coords.longitude).toFixed(6)}¬∞W
Copy/Paste: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;

                        // Copy to clipboard
                        navigator.clipboard.writeText(`${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`).then(() => {
                            console.log("üìã Coordinates copied to clipboard:", `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`);
                            
                            // Show a temporary success message
                            const originalText = document.getElementById('copy-coordinates-btn').textContent;
                            document.getElementById('copy-coordinates-btn').textContent = 'Copied!';
                            document.getElementById('copy-coordinates-btn').style.backgroundColor = '#218838';
                            
                            setTimeout(() => {
                                document.getElementById('copy-coordinates-btn').textContent = originalText;
                                document.getElementById('copy-coordinates-btn').style.backgroundColor = '#28a745';
                            }, 2000);
                            
                        }).catch(err => {
                            console.error('‚ùå Failed to copy coordinates:', err);
                            // Fallback: show coordinates in an alert for manual copying
                            alert(coordText);
                        });
                    } else {
                        alert('No user selected. Please click on a user first.');
                    }
                });

                // Find and configure the Fire Hazard Layer
                fireHazardLayer = map.allLayers.find(layer => layer.title === "Fire Hazard Severity Zones");
                if (fireHazardLayer) {
                    console.log("üî• Found Fire Hazard Severity Zones layer. Waiting for it to load...");
                    fireHazardLayer.when(() => {
                        console.log("üî• Fire Hazard layer is ready!");
                        appState.fireHazardLayerReady = true;
                        checkIfAllDataReady();
                    }).catch(error => {
                        console.error("‚ùå Fire Hazard Severity Zones layer failed to load:", error);
                        updateStatus("Fire Hazard layer failed to load. Notifications disabled.", true);
                    });
                    fireHazardLayer.visible = true;
                } else {
                    console.error("‚ùå Could not find 'Fire Hazard Severity Zones' layer.");
                    updateStatus("Fire Hazard layer not found. Notifications disabled.", true);
                }

                // Find and configure the LocAid Users Layer
                userSignUpLayer = map.allLayers.find(layer => layer.title === "LocAid Users");
                if (userSignUpLayer) {
                    console.log("üë• Found LocAid Users layer. Loading user data...");
                    userSignUpLayer.popupEnabled = true;
                    
                    userSignUpLayer.when(() => {
                        return userSignUpLayer.queryFeatures({
                            where: "1=1", // Get all records (required by ArcGIS)
                            outFields: ["*"], // Get all fields
                            returnGeometry: true // We need geometry for click matching and notifications
                        });
                    })
                    .then(results => {
                        console.log(`üë• Successfully loaded ${results.features.length} user records from LocAid Users layer.`);
                        signUpData = results.features;
                        appState.userDataLoaded = true;
                        
                        // Log a sample of the data for verification
                        if (results.features.length > 0) {
                            const sampleUser = results.features[0].attributes;
                            console.log("Sample user data:", sampleUser);
                        }
                        
                        checkIfAllDataReady();
                    })
                    .catch(err => {
                        console.error("‚ùå Error loading LocAid Users data:", err);
                        updateStatus("Failed to load user data. Notifications disabled.", true);
                    });
                } else {
                    console.warn("‚ùå Could not find 'LocAid Users' layer in the WebMap.");
                    updateStatus("LocAid Users layer not found. Notifications disabled.", true);
                }
            });


            // --- WEBSOCKET CONNECTION ---
            setupWebSocket();

            function setupWebSocket() {
                const socket = new WebSocket(WEBSOCKET_URL);

                socket.onopen = () => updateStatus('Connected to relay server.', false, true);

                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    // Check if it's an array (initial address load) or single object (live update)
                    if (Array.isArray(data)) {
                        console.log(`Received initial batch of ${data.length} static addresses.`);
                        data.forEach(address => updateMapGraphic(address));
                    } else {
                        updateStatus(`Received location from ${data.deviceId}`, false);
                        updateMapGraphic(data);
                    }
                };

                socket.onclose = () => {
                    updateStatus('Disconnected. Retrying...', true);
                    console.error("WebSocket closed. Is the server running? Retrying...");
                    setTimeout(setupWebSocket, 3000);
                };

                socket.onerror = (error) => {
                    updateStatus('WebSocket error.', true);
                    console.error('WebSocket Error:', error);
                    socket.close();
                };
            }

            function updateLiveUnitsList() {
                const listContainer = document.getElementById('live-units-list');
                listContainer.innerHTML = ''; // Clear the list
                for (const deviceId in liveGraphics) {
                    const listItem = document.createElement('div');
                    listItem.textContent = deviceId;
                    listItem.style.cursor = 'pointer';
                    listItem.style.padding = '5px';
                    listItem.dataset.deviceId = deviceId;
                    listContainer.appendChild(listItem);
                }
            }

            document.getElementById('live-units-list').addEventListener('click', (event) => {
                const deviceId = event.target.dataset.deviceId;
                if (deviceId && liveGraphics[deviceId]) {
                    // Zoom to the live unit
                    view.goTo(liveGraphics[deviceId].point.geometry);
                    
                    // Populate the selected user panel with live unit info
                    const liveUnit = liveGraphics[deviceId];
                    const attrs = liveUnit.point.attributes;
                    const geometry = liveUnit.point.geometry;
                    
                    // Create a selectedFeature object similar to the LocAid Users
                    selectedFeature = {
                        geometry: geometry,
                        attributes: {
                            deviceId: deviceId,
                            type: attrs.type || 'unknown',
                            accuracy: attrs.accuracy || 'N/A',
                            // For live units, we don't have first_name/last_name, so we'll use deviceId
                            first_name: deviceId,
                            last_name: '',
                            phone_number: 'N/A',
                            disability_type: attrs.type === 'responder' ? 'First Responder' : 'Live User'
                        }
                    };
                    
                    const name = deviceId;
                    const unitType = attrs.type === 'responder' ? 'First Responder' : 'Live User';
                    
                    document.getElementById('selected-user-info').innerHTML = `
                        <strong>Unit ID:</strong> ${name}<br>
                        <strong>Type:</strong> ${unitType}<br>
                        <strong>Accuracy:</strong> ${attrs.accuracy || 'N/A'}m<br>
                        <strong>Coordinates:</strong> ${geometry.latitude.toFixed(6)}, ${geometry.longitude.toFixed(6)}
                    `;
                    document.getElementById('selected-user-panel').style.display = 'block';
                    console.log("‚úÖ Selected live unit:", attrs);
                }
            });


            function updateMapGraphic(locationData) {
                const { latitude, longitude, deviceId, accuracy, type = 'user' } = locationData;
                
                if (type === 'address') {
                    // This is where you would load a FeatureLayer in a real app.
                    // For now, we create graphics from the simulated data.
                    if (!addressGraphics[deviceId]) {
                         const point = new Point({ longitude, latitude });
                         const addressSymbol = {
                            type: "simple-marker",
                            style: "diamond",
                            size: 6, // Smaller size for static data
                            color: [0, 0, 139], // Dark Blue
                            outline: { width: 1, color: "white" }
                         };
                         const addressGraphic = new Graphic({
                             geometry: point,
                             symbol: addressSymbol,
                             attributes: locationData,
                             popupTemplate: {
                                 title: "Vulnerable Address",
                                 content: "Device ID: {deviceId}"
                             }
                         });
                         graphicsLayer.add(addressGraphic);
                         addressGraphics[deviceId] = addressGraphic;
                    }
                    return; // End processing for static addresses
                }

                const point = new Point({
                    longitude: longitude,
                    latitude: latitude
                });

                const accuracyCircle = geometryEngine.geodesicBuffer(point, accuracy, "meters");

                // Define symbols based on the user type
                const pointColor = type === 'responder' ? [0, 122, 194] : [226, 119, 40]; // Blue for responders, Orange for users
                const pointSymbol = {
                    type: "simple-marker",
                    size: 12, // Increased size for better visibility
                    color: pointColor,
                    outline: { width: 1, color: "white" }
                };
                const circleSymbol = {
                    type: "simple-fill",
                    color: [...pointColor, 0.2], // Use the same base color but with transparency
                    outline: {
                        color: [255, 255, 255, 0.5],
                        width: 1
                    }
                };
                
                if (liveGraphics[deviceId]) {
                    const graphics = liveGraphics[deviceId];
                    graphics.point.geometry = point;
                    graphics.circle.geometry = accuracyCircle;
                    graphics.point.symbol = pointSymbol; // Update symbol in case type changes
                    graphics.circle.symbol = circleSymbol;
                    graphics.point.attributes.accuracy = accuracy ? accuracy.toFixed(0) : 0;
                    graphics.lastUpdate = Date.now(); // Update timestamp
                } else {
                    const circleGraphic = new Graphic({
                        geometry: accuracyCircle,
                        symbol: circleSymbol
                    });

                    const pointGraphic = new Graphic({
                        geometry: point,
                        symbol: pointSymbol,
                        attributes: {
                            deviceId: deviceId,
                            accuracy: accuracy ? accuracy.toFixed(0) : 0,
                            type: type
                        },
                        popupTemplate: {
                            title: "{type}: {deviceId}",
                            content: "Reported accuracy: {accuracy} meters."
                        }
                    });

                    graphicsLayer.addMany([circleGraphic, pointGraphic]);
                    
                    liveGraphics[deviceId] = {
                        point: pointGraphic,
                        circle: circleGraphic,
                        lastUpdate: Date.now() // Set initial timestamp
                    };
                    updateLiveUnitsList(); // Update the list when a new unit appears

                    if (graphicsLayer.graphics.length > 0) {
                        view.goTo(graphicsLayer.graphics);
                    }
                }
            }

            function cleanupStaleData() {
                const now = Date.now();
                for (const deviceId in liveGraphics) {
                    if (now - liveGraphics[deviceId].lastUpdate > STALE_DATA_TIMEOUT) {
                        console.log(`Removing stale unit: ${deviceId}`);
                        graphicsLayer.remove(liveGraphics[deviceId].point);
                        graphicsLayer.remove(liveGraphics[deviceId].circle);
                        delete liveGraphics[deviceId];
                        updateLiveUnitsList(); // Update the list
                    }
                }
            }
            setInterval(cleanupStaleData, 10000); // Check for stale data every 10 seconds

            function updateStatus(message, isError = false, isConnectionStatus = false) {
                const targetDiv = isConnectionStatus ? connectionStatusDiv : statusDiv;
                targetDiv.textContent = message;
                targetDiv.style.color = isError ? '#d9534f' : '#28a745';
                
                if (isConnectionStatus) {
                    targetDiv.style.fontWeight = 'bold';
                }

                if (!isConnectionStatus) {
                    statusDiv.style.display = 'block';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
                }
            }

            function showNotificationModal(users) {
                const list = document.getElementById('notified-users-list');
                list.innerHTML = '<ul>' + users.map(user => {
                    const name = `${user.attributes.first_name || ''} ${user.attributes.last_name || ''}`.trim() || 'N/A';
                    const phone = user.attributes.phone_number || 'N/A';
                    return `<li><strong>${name}</strong> - ${phone}</li>`;
                }).join('') + '</ul>';

                document.getElementById('notification-modal').style.display = 'flex';
            }

            function hideNotificationModal() {
                document.getElementById('notification-modal').style.display = 'none';
            }

            // Add event listener for the modal close button
            document.querySelector('.close-button').addEventListener('click', hideNotificationModal);
            // Also close when clicking the overlay
            document.getElementById('notification-modal').addEventListener('click', (event) => {
                if (event.target.id === 'notification-modal') {
                    hideNotificationModal();
                }
            });


            document.getElementById('notifyBtn').addEventListener('click', () => {
                if (!fireHazardLayer) {
                    updateStatus("Fire Hazard Layer not ready. Cannot perform notification.", true);
                    return;
                }
                if (signUpData.length === 0) {
                    updateStatus("User sign-up data not loaded yet.", true);
                    return;
                }
                console.log("Starting notification process for signed-up users...");

                const userGeometries = signUpData.map(f => f.geometry).filter(g => g != null);
                if (userGeometries.length === 0) {
                    updateStatus("No users with valid locations found.", false);
                    return;
                }

                const query = fireHazardLayer.createQuery();
                query.geometry = { type: "multipoint", points: userGeometries.map(g => [g.longitude, g.latitude]) };
                query.spatialRelationship = "intersects";
                // We don't need any fields back from the fire layer, just its geometry.
                // query.outFields = ["first_name", "last_name", "phone_number", "objectid"]; 
                query.returnGeometry = true; 

                // --- LOG 2: Log the exact query object being sent ---
                console.log("Executing spatial query with parameters:", JSON.stringify(query.toJSON(), null, 2));

                fireHazardLayer.queryFeatures(query).then(featureSet => {
                    const vulnerableUsers = featureSet.features;
                    if (!vulnerableUsers || vulnerableUsers.length === 0) {
                        updateStatus("No signed-up users are within high fire hazard zones.", false);
                        return;
                    }

                    const notifiedUsers = signUpData.filter(userFeature => {
                        const userGeom = userFeature.geometry;
                        if (!userGeom) return false;
                        // Check if the user's location intersects with any of the returned fire zones
                        return vulnerableUsers.some(fireFeature => geometryEngine.intersects(fireFeature.geometry, userGeom));
                    });
                    
                    if (notifiedUsers.length > 0) {
                        showNotificationModal(notifiedUsers);
                        updateStatus(`${notifiedUsers.length} vulnerable users notified!`, false);

                        // --- Trigger Emails ---
                        notifiedUsers.forEach(user => {
                            const attrs = user.attributes;
                            const name = `${attrs.first_name || ''} ${attrs.last_name || ''}`.trim();
                            const email = attrs.email_address;

                            if (email && name) {
                                fetch('/send-notification', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ email, name })
                                })
                                .then(response => response.json())
                                .then(data => console.log(`Notification email sent for ${name}:`, data.message))
                                .catch(err => console.error(`Failed to send notification email for ${name}:`, err));
                            }
                        });

                    } else {
                        updateStatus("No signed-up users are within high fire hazard zones.", false);
                    }
                
                }).catch(err => {
                    console.error("Error querying fire hazard layer for users:", err);
                    updateStatus("Error during user notification.", true);
                });
            });
        });
    </script>
</body>
</html> 